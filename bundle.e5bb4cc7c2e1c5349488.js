(()=>{"use strict";(()=>{class e{constructor(e=32,s=64){this.rows=e,this.cols=s,this.display=Array.from(Array(this.rows),(()=>new Array(this.cols).fill(0)))}get rowCount(){return this.rows}get colCount(){return this.cols}clearScreen(){this.display=Array.from(Array(this.rows),(()=>new Array(this.cols).fill(0)))}setPixelOn(e,s){this.display[s][e]=1}setPixelOff(e,s){this.display[s][e]=0}getPixelAt(e,s){return this.display[s][e]}}class s{keymap={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,86:15};constructor(){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this))}keyState=new Array(16);onKeyDown(e){const s=e.keyCode;s in this.keymap&&(this.keyState[this.keymap[s]]=!0,console.log(this.keymap[s]+" pressed down"))}onKeyUp(e){const s=e.keyCode;s in this.keymap&&(this.keyState[this.keymap[s]]=!1,console.log(this.keymap[s]+" pressed up"))}isKeyPressed(e){return this.keyState[e]}getAnyKeyPressed(){return this.keyState.indexOf(!0)}}class t{constructor(e=4096){this.memorySize=e,this.memory=new Uint8Array(this.memorySize)}reset(){this.memory=new Uint8Array(this.memorySize)}read(e){return this.memory[e]}write(e,s){this.memory[e]=s}fetchInstruction(e){return this.read(e)<<8|this.read(e+1)}load(e,s){for(const t of e)this.write(s,t),s++}}class i{SP=0;constructor(e=16){this.size=e,this.stack=new Uint16Array(e)}reset(){this.stack=new Uint16Array(this.size)}push(e){this.stack[this.SP]=e,this.SP++}pop(){return this.SP>0&&this.SP--,this.stack[this.SP]}}class r{constructor(e){this.frameBuffer=e}update(){var e=document.getElementById("myCanvas"),s=e.getContext("2d");const t=e.width/this.frameBuffer.colCount,i=e.height/this.frameBuffer.rowCount;for(let e=0;e<this.frameBuffer.rowCount;e++)for(let r=0;r<this.frameBuffer.colCount;r++)1==this.frameBuffer.getPixelAt(r,e)?s.fillStyle="white":s.fillStyle="black",s.fillRect(r*t,e*i,t,i)}}class h{constructor(e=16){this.registerCount=e,this.registers=new Uint8Array(e)}reset(){this.registers=new Uint8Array(this.registerCount)}getRegister(e){return this.registers[e]}addToReg(e,s){this.registers[e]+=s}copyReg(e,s){this.registers[e]=this.registers[s]}setRegister(e,s){this.registers[e]=s}}class a{I=80;PC=512;delayTimer=0;soundTimer=0;constructor(e,s,t,i,r,h){this.memory=e,this.stack=s,this.registers=t,this.frameBuffer=i,this.display=r,this.keyboard=h}startTimers(){this.delayTimerInterval=setInterval(this.updateDelayTimer.bind(this),16.666666666666668),this.soundTimerInterval=setInterval(this.updateSoundTimer.bind(this),16.666666666666668)}stopTimers(){clearInterval(this.delayTimerInterval),clearInterval(this.soundTimer)}reset(){this.I=80,this.PC=512,this.delayTimer=0,this.soundTimer=0,this.memory.reset(),this.registers.reset(),this.stack.reset(),this.cls()}cycle(){const e=this.memory.fetchInstruction(this.PC);this.PC+=2;const s=this.decode(e);this.execute(s)}updateDelayTimer(){this.delayTimer>0&&this.delayTimer--}updateSoundTimer(){this.soundTimer>0&&this.soundTimer--}decode(e){return{raw:e,opcode:61440&e,func:15&e,vx:(3840&e)>>8,vy:(240&e)>>4,n:15&e,nn:255&e,nnn:4095&e}}execute(e){const s=e.opcode,t=e.func,i=e.vx,r=e.vy,h=e.n,a=e.nn,o=e.nnn;switch(s){case 0:switch(e.raw){case 224:this.cls();break;case 238:this.ret();break;default:console.log(e+" is not implemented")}break;case 4096:this.jump(o);break;case 8192:this.call(o);break;case 12288:this.skipEqi(i,a);break;case 16384:this.skipNeqi(i,a);break;case 20480:this.skipEq(i,r);break;case 24576:this.loadi(i,a);break;case 28672:this.addi(i,a);break;case 32768:switch(t){case 0:this.load(i,r);break;case 1:this.or(i,r);break;case 2:this.and(i,r);break;case 3:this.xor(i,r);break;case 4:this.add(i,r);break;case 5:this.sub(i,r);break;case 6:this.shiftRight(i);break;case 7:this.subReverse(i,r);break;case 14:this.shiftLeft(i);break;default:console.log(e+" is not implemented")}break;case 36864:this.skipNeq(i,r);break;case 40960:this.loadIndex(o);break;case 45056:this.jumpOffset(o);break;case 49152:this.rnd(i,a);break;case 53248:this.draw(i,r,h);break;case 57344:switch(255&e.raw){case 158:this.skipPressed(i);break;case 161:this.skipNotPressed(i);break;default:console.log(e+" is not implemented")}break;case 61440:switch(255&e.raw){case 7:this.loadVxDt(i);break;case 10:this.getKey(i);break;case 21:this.loadDtVx(i);break;case 24:this.loadStVx(i);break;case 30:this.addIndex(i);break;case 41:this.indexTofontCharacter(i);break;case 51:this.toDecimal(i);break;case 85:this.saveRegisters(i);break;case 101:this.loadRegisters(i)}break;default:console.log(e+" is not implemented")}}cls(){this.frameBuffer.clearScreen(),this.display.update()}ret(){this.PC=this.stack.pop()}jump(e){this.PC=e}call(e){this.stack.push(this.PC),this.PC=e}skipEqi(e,s){this.registers.getRegister(e)==s&&(this.PC+=2)}skipNeqi(e,s){this.registers.getRegister(e)!=s&&(this.PC+=2)}skipEq(e,s){this.registers.getRegister(e)==this.registers.getRegister(s)&&(this.PC+=2)}loadi(e,s){this.registers.setRegister(e,s)}addi(e,s){this.registers.addToReg(e,s)}load(e,s){this.registers.copyReg(e,s)}or(e,s){this.registers.setRegister(e,this.registers.getRegister(e)|this.registers.getRegister(s))}and(e,s){this.registers.setRegister(e,this.registers.getRegister(e)&this.registers.getRegister(s))}xor(e,s){this.registers.setRegister(e,this.registers.getRegister(e)^this.registers.getRegister(s))}add(e,s){this.registers.getRegister(e)+this.registers.getRegister(s)>255&&this.registers.setRegister(15,1),this.registers.addToReg(e,this.registers.getRegister(s))}sub(e,s){this.registers.getRegister(e)>this.registers.getRegister(s)?this.registers.setRegister(15,1):this.registers.setRegister(15,0),this.registers.setRegister(e,this.registers.getRegister(e)-this.registers.getRegister(s))}shiftRight(e){this.registers.setRegister(15,1&this.registers.getRegister(e)),this.registers.setRegister(e,this.registers.getRegister(e)>>1)}subReverse(e,s){this.registers.getRegister(s)>this.registers.getRegister(e)?this.registers.setRegister(15,1):this.registers.setRegister(15,0),this.registers.setRegister(e,this.registers.getRegister(s)-this.registers.getRegister(e))}shiftLeft(e){this.registers.setRegister(15,1&this.registers.getRegister(e)),this.registers.setRegister(e,this.registers.getRegister(e)<<1)}skipNeq(e,s){this.registers.getRegister(e)!=this.registers.getRegister(s)&&(this.PC+=2)}loadIndex(e){this.I=e}jumpOffset(e){this.PC=this.registers.getRegister(0)+e}rnd(e,s){this.registers.setRegister(e,Math.floor(256*Math.random())&s)}draw(e,s,t){this.registers.setRegister(15,0);let i=this.registers.getRegister(s)%this.frameBuffer.rowCount;for(let s=0;s<t&&!(i>=this.frameBuffer.rowCount);s++){let t=this.registers.getRegister(e)%this.frameBuffer.colCount;const r=this.memory.read(this.I+s);for(let e=128;e>=1&&!(t>=this.frameBuffer.colCount);e/=2){const s=r&e;0!=s&&0!=this.frameBuffer.getPixelAt(t,i)?(this.frameBuffer.setPixelOff(t,i),this.registers.setRegister(15,1)):0!=s&&0==this.frameBuffer.getPixelAt(t,i)&&this.frameBuffer.setPixelOn(t,i),t++}i++}this.display.update()}skipPressed(e){this.keyboard.isKeyPressed(this.registers.getRegister(e))&&(this.PC+=2)}skipNotPressed(e){this.keyboard.isKeyPressed(this.registers.getRegister(e))||(this.PC+=2)}loadVxDt(e){this.registers.setRegister(e,this.delayTimer)}loadDtVx(e){this.delayTimer=this.registers.getRegister(e)}loadStVx(e){this.soundTimer=this.registers.getRegister(e)}getKey(e){const s=this.keyboard.getAnyKeyPressed;s>=0?this.PC-=2:this.registers.setRegister(e,s)}addIndex(e){this.I=this.I+this.registers.getRegister(e)}indexTofontCharacter(e){this.I=80+5*this.registers.getRegister(e)}toDecimal(e){const s=this.registers.getRegister(e).toString().padStart(3,"0").split("").map(Number);for(let e=0;e<=2;e++)this.memory.write(this.I+e,s[e])}saveRegisters(e){for(let s=0;s<=e;s++)this.memory.write(this.I+s,this.registers.getRegister(s))}loadRegisters(e){for(let s=0;s<=e;s++)this.registers.setRegister(s,this.memory.read(this.I+s))}}const o={0:[240,144,144,144,240],1:[32,96,32,32,112],2:[240,16,240,128,240],3:[240,16,240,16,240],4:[144,144,240,16,16],5:[240,128,240,16,240],6:[240,128,240,144,240],7:[240,16,32,64,64],8:[240,144,240,144,240],9:[240,144,240,16,240],10:[240,144,240,144,144],11:[224,144,224,144,224],12:[240,128,128,128,240],13:[224,144,144,144,224],14:[240,128,240,128,240],15:[240,128,240,128,128]};const g=new class{frameBuffer=new e(32,64);keyboard=new s;memory=new t(4096);stack=new i;display=new r(this.frameBuffer);registers=new h(16);cpu=new a(this.memory,this.stack,this.registers,this.frameBuffer,this.display,this.keyboard);loadFontToMemory(){let e=80;for(const s in o)this.memory.load(o[s],e),e+=o[s].length}loadProgramToMemory(e){this.memory.load(e,512)}start(){this.cpu.startTimers(),this.cycleInterval=setInterval(this.cpu.cycle.bind(this.cpu),1.4285714285714286)}pasue(){this.cpu.stopTimers(),clearInterval(this.cycleInterval)}stop(){clearInterval(this.cycleInterval),this.cpu.stopTimers(),this.cpu.reset(),this.display.update()}next(){this.cpu.cycle()}};document.getElementById("rom-selector").addEventListener("change",(function(){const e=this.value;fetch(`/roms/${e}`).then((e=>{if(!e.ok)throw new Error("ROM not found");return e.arrayBuffer()})).then((e=>{g.stop();const s=new Uint8Array(e);g.loadFontToMemory(),g.loadProgramToMemory(s),g.start()})).catch((e=>{console.log(`${e}`),g.stop()}))}))})()})();